<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KIRILMA | League Edition</title>
    <style>
        :root {
            --bg-color: #2b1d38;
            --panel-bg: #402a52;
            --text-main: #ffffff;
            --text-muted: #dccae8;
            
            --border-color: #593a73;
            --tile-size: 58px;
            --gap: 4px;
            
            --font-ui: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;

            /* Lig Renkleri */
            --league-bronze: #cd7f32;
            --league-silver: #c0c0c0;
            --league-gold: #ffd700;
            --league-crystal: #00ffff;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background: radial-gradient(circle at center, #3c2a4d 0%, #1a1025 100%);
            color: var(--text-main);
            font-family: var(--font-ui);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #app {
            width: 100%;
            max-width: 600px;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            position: relative;
            z-index: 10;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            margin-bottom: 10px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(to bottom, #fff, #ffd1ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            letter-spacing: 1px;
        }

        .level-badge {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
            color: #d63384;
            padding: 5px 15px;
            font-weight: bold;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .icon-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: #fff;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* Main Game Area */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            overflow: hidden;
        }

        /* Game Board */
        #game-board-container {
            position: relative;
            padding: 10px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.05);
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: var(--gap);
            width: fit-content;
            touch-action: none;
        }
        
        /* Cells & Layers */
        .cell { width: var(--tile-size); height: var(--tile-size); position: relative; background: rgba(0,0,0,0.2); border-radius: 8px; }
        .crack-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 8px; pointer-events: none; z-index: 0; opacity: 0.8; transition: all 0.3s; }
        .crack-layer.lvl-1 { background: rgba(255, 255, 255, 0.15); box-shadow: inset 0 0 10px rgba(255,255,255,0.3); border: 1px dashed rgba(255,255,255,0.3); }
        .crack-layer.lvl-2 { background: rgba(255, 255, 255, 0.3); box-shadow: inset 0 0 15px rgba(255,255,255,0.5); border: 2px solid rgba(255,255,255,0.4); }
        .crack-layer::after { content: ''; position: absolute; top:0; left:0; right:0; bottom:0; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.2) 10px, rgba(255,255,255,0.2) 12px); opacity: 0; }
        .crack-layer.lvl-1::after { opacity: 0.3; } .crack-layer.lvl-2::after { opacity: 0.6; }

        /* Tiles */
        .tile { width: 100%; height: 100%; position: relative; z-index: 1; cursor: pointer; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; filter: drop-shadow(0px 4px 3px rgba(0,0,0,0.4)); }
        .tile::before { content: ''; position: absolute; width: 90%; height: 90%; border-radius: inherit; box-shadow: inset 0px -4px 6px rgba(0,0,0,0.3), inset 2px 2px 5px rgba(255,255,255,0.6); z-index: 1; }
        .tile::after { content: ''; position: absolute; top: 20%; left: 20%; width: 25%; height: 15%; background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(255,255,255,0.1)); border-radius: 50%; transform: rotate(-45deg); pointer-events: none; z-index: 2; }
        .tile[data-type="0"]::before { background: radial-gradient(circle at 35% 35%, #ff758c, #d6334c); border-radius: 40% 40% 45% 45% / 55% 55% 40% 40%; }
        .tile[data-type="1"]::before { background: radial-gradient(circle at 30% 30%, #4facfe, #00f2fe); border-radius: 50%; }
        .tile[data-type="2"]::before { background: radial-gradient(circle at 30% 30%, #a8e063, #56ab2f); border-radius: 12px; }
        .tile[data-type="3"]::before { background: radial-gradient(circle at 40% 40%, #fff200, #ffc300); border-radius: 50%; clip-path: ellipse(45% 50% at 50% 50%); } .tile[data-type="3"]::after { top: 25%; left: 25%; }
        .tile[data-type="4"]::before { background: radial-gradient(circle at 30% 30%, #cd93ff, #6a11cb); border-radius: 50%; border: 4px solid rgba(255,255,255,0.2); box-sizing: border-box; }
        .tile.selected { transform: scale(1.15); filter: drop-shadow(0 0 10px gold); z-index: 10; }
        .tile.matched { animation: pop 0.3s forwards; }
        
        /* HUD Panel */
        #hud { width: 100%; display: flex; justify-content: space-between; gap: 10px; padding: 0 5px; }
        .panel { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 8px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; backdrop-filter: blur(5px); min-height: 80px; }
        .stat-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; margin-bottom: 5px; }
        .stat-value { font-size: 1.4rem; font-weight: 800; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        
        /* Goal Styles */
        #goal-container { display: flex; flex-direction: column; gap: 5px; width: 100%; }
        .goal-item { display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; font-weight: bold; width: 100%; background: rgba(0,0,0,0.2); padding: 4px 8px; border-radius: 6px; }
        .goal-item.done { opacity: 0.5; text-decoration: line-through; color: #a8e063; }
        .mini-tile { width: 16px; height: 16px; border-radius: 50%; box-shadow: inset -1px -1px 3px rgba(0,0,0,0.3); display: inline-block;}
        .crack-icon { width: 16px; height: 16px; background: rgba(255,255,255,0.5); border: 1px dashed #fff; transform: rotate(45deg); }

        .btn { background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%); border: none; color: #fff; padding: 12px; width: 100%; font-weight: bold; text-transform: uppercase; cursor: pointer; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.2); font-size: 0.9rem; transition: transform 0.1s; }
        .btn:active { transform: scale(0.98); }
        .btn-boost { background: linear-gradient(to bottom, #f093fb 0%, #f5576c 100%); }
        .btn-secondary { background: rgba(255,255,255,0.1); font-size: 0.8rem; padding: 10px; border: 1px solid rgba(255,255,255,0.1);}

        /* LEAGUE & LEADERBOARD STYLES */
        #league-overlay .overlay-content { padding: 0; overflow: hidden; height: 70vh; display: flex; flex-direction: column; background: #2b1d38; }
        .league-header { padding: 20px; text-align: center; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .league-title { font-size: 1.5rem; margin: 0; font-weight: 900; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .league-subtitle { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }
        
        .league-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-top: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.5); text-transform: uppercase;}
        .badge-bronze { background: var(--league-bronze); color: #fff; }
        .badge-silver { background: linear-gradient(135deg, #e0e0e0 0%, #c0c0c0 100%); color: #444; }
        .badge-gold { background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%); color: #444; }
        .badge-crystal { background: linear-gradient(135deg, #00ffff 0%, #0099ff 100%); color: #000; box-shadow: 0 0 15px var(--league-crystal); }

        .leaderboard-list { flex: 1; overflow-y: auto; padding: 10px; }
        .leaderboard-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .lb-rank { width: 30px; font-weight: bold; color: #888; text-align: center; }
        .lb-rank-1 { color: #ffd700; font-size: 1.2rem; }
        .lb-rank-2 { color: #c0c0c0; font-size: 1.1rem; }
        .lb-rank-3 { color: #cd7f32; font-size: 1.1rem; }
        
        .lb-user { flex: 1; padding-left: 10px; display: flex; flex-direction: column; }
        .lb-name { font-weight: bold; font-size: 0.9rem; }
        .lb-score { font-weight: bold; color: #a8e063; font-size: 0.9rem; }

        .lb-profile-row { background: rgba(79, 172, 254, 0.2); border-top: 1px solid rgba(255,255,255,0.2); padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 -5px 15px rgba(0,0,0,0.3); }
        .lb-profile-info { display: flex; align-items: center; gap: 10px; }

        /* Overlays & Drawers */
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(20, 10, 30, 0.95); backdrop-filter: blur(8px); z-index: 100; display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .overlay.active { display: flex; animation: fadeIn 0.3s; }
        .overlay-content { width: 85%; padding: 25px; background: linear-gradient(135deg, #2b1d38, #1a1025); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
        .overlay h2 { font-size: 2.2rem; margin-bottom: 15px; margin-top:0; }
        .win-title { background: linear-gradient(to right, #a8e063, #56ab2f); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .lose-title { background: linear-gradient(to right, #ff758c, #d6334c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        #boost-drawer { position: absolute; bottom: -350px; left: 0; width: 100%; height: auto; background: #251830; border-top: 2px solid rgba(255,255,255,0.1); border-radius: 20px 20px 0 0; z-index: 50; transition: bottom 0.3s; padding: 20px; box-shadow: 0 -10px 40px rgba(0,0,0,0.6); }
        #boost-drawer.open { bottom: 0; }
        .boost-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.05); margin-bottom: 10px; cursor: pointer; }

        #token-display { display: flex; align-items: center; gap: 6px; font-weight: bold; color: #ffd700; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 15px; }
        .token-icon { width: 14px; height: 14px; background: #ffd700; border-radius: 50%; box-shadow: inset -2px -2px 5px rgba(0,0,0,0.4); border: 1px solid #fff; }

        footer { margin-top: auto; width: 100%; padding: 10px; display: flex; justify-content: space-between; font-size: 0.8rem; color: rgba(255,255,255,0.5); }
        
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.3); opacity: 1; } 100% { transform: scale(0); opacity: 0; } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .float-text { position: absolute; color: #fff; font-weight: 900; font-size: 1.5rem; pointer-events: none; animation: floatUp 0.6s ease-out forwards; z-index: 20; text-shadow: 0 2px 4px rgba(0,0,0,0.5); background: linear-gradient(to bottom, #fff, #ffd1ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-40px) scale(1.2); opacity: 0; } }

        @media (max-width: 768px) {
            :root { --tile-size: 11.5vw; --gap: 3px; }
            #hud { padding: 0; }
        }
    </style>
</head>
<body>

<div id="app">
    <header>
        <h1>KIRILMA</h1>
        <div class="level-badge" id="level-display">SEVƒ∞YE 1</div>
        <div style="display:flex; gap:8px; align-items: center;">
            <div id="token-display"><div class="token-icon"></div> <span id="token-count">0</span></div>
            <!-- League Button -->
            <button class="icon-btn" style="background: rgba(255, 215, 0, 0.2); border-color: #ffd700;" onclick="Game.league.openLeague()">üèÜ</button>
            <button class="icon-btn" onclick="Game.ui.toggleSettings()">‚öôÔ∏è</button>
        </div>
    </header>

    <main>
        <div id="hud">
            <div class="panel" style="flex: 0.6;">
                <div class="stat-label">HAMLE</div>
                <div class="stat-value" id="moves-display">20</div>
            </div>
            
            <div class="panel" style="flex: 1.4; align-items: stretch;">
                <div class="stat-label" style="text-align: center;">HEDEFLER</div>
                <div id="goal-container"></div>
            </div>

            <div class="panel" style="flex: 0.8;">
                <div class="stat-label">PUAN</div>
                <div class="stat-value" style="font-size: 1.1rem" id="score-display">0</div>
            </div>
        </div>

        <div id="game-board-container">
            <div id="grid"></div>
        </div>

        <div style="width:100%; display: flex; gap: 10px; margin-top: 5px; padding: 0 5px;">
            <button class="btn btn-boost" onclick="Game.ui.toggleBoostDrawer()">‚ö° MARKET</button>
            <button class="btn btn-secondary" style="width: 80px;" onclick="Game.logic.restartLevel()">‚Ü∫</button>
        </div>
    </main>

    <footer>
        <button class="icon-btn" id="sound-toggle" style="background:none; border:none;" onclick="Game.audio.toggle()">üîä</button>
        <span id="tip-text" style="color: rgba(255,255,255,0.4)">Kaydƒ±rarak E≈üle≈ütir</span>
        <button class="icon-btn" style="background:none; border:none;" onclick="Game.ui.showHelp()">?</button>
    </footer>

    <!-- Boost Drawer -->
    <div id="boost-drawer">
        <h3 style="color:#fff; margin-top:0; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom:10px;">MARKET</h3>
        <button class="icon-btn" onclick="Game.ui.toggleBoostDrawer()" style="position:absolute; top:15px; right:15px; background:rgba(255,255,255,0.1); width:30px; height:30px; display:flex; align-items:center; justify-content:center;">‚úï</button>
        
        <div class="boost-item" onclick="Game.logic.useBooster('move')"><span><b>+5 HAMLE</b></span> <span style="color:#ffd700; font-weight:bold;">10 Jeton</span></div>
        <div class="boost-item" onclick="Game.logic.useBooster('shuffle')"><span><b>KARI≈ûTIR</b></span> <span style="color:#ffd700; font-weight:bold;">15 Jeton</span></div>
        <div class="boost-item" onclick="Game.logic.useBooster('smash')"><span><b>RENK Sƒ∞L</b> (Kƒ±rmƒ±zƒ±)</span> <span style="color:#ffd700; font-weight:bold;">25 Jeton</span></div>
    </div>
</div>

<!-- LEAGUE OVERLAY (NEW) -->
<div id="overlay-league" class="overlay">
    <div class="overlay-content">
        <div class="league-header">
            <h2 class="league-title">Lƒ∞G TABLOSU</h2>
            <div class="league-subtitle" id="week-display">Hafta 1</div>
            <div id="league-tier-badge" class="league-badge badge-bronze">BRONZ Lƒ∞G</div>
        </div>
        
        <div class="leaderboard-list" id="lb-list">
            <!-- Mock Items -->
        </div>

        <div class="lb-profile-row">
            <div class="lb-profile-info">
                <div style="font-size:1.5rem">üë§</div>
                <div>
                    <div style="font-weight:bold; font-size:0.9rem">SEN</div>
                    <div style="color:#a8e063; font-size:0.8rem" id="my-weekly-score">0 Puan</div>
                </div>
            </div>
            <div style="font-size:1.2rem; font-weight:bold" id="my-rank">#--</div>
        </div>
        
        <div style="padding:15px; display:flex; gap:10px; background:#2b1d38">
             <button class="btn btn-secondary" onclick="Game.league.renderLeaderboard()">YENƒ∞LE</button>
             <button class="btn" onclick="document.getElementById('overlay-league').classList.remove('active')">KAPAT</button>
        </div>
    </div>
</div>

<!-- Overlays -->
<div id="overlay-main" class="overlay">
    <div class="overlay-content">
        <h2 id="overlay-title">BA≈ûARDIN!</h2>
        <p id="overlay-msg" style="margin-bottom:25px; font-size:1.1rem; color:#dccae8;"></p>
        <div id="overlay-buttons" style="display:flex; flex-direction:column; gap:10px;"></div>
    </div>
</div>

<div id="overlay-settings" class="overlay">
    <div class="overlay-content">
        <h2>AYARLAR</h2>
        <button class="btn" style="background:#ff5e57; margin-top:10px" onclick="Game.data.resetProgress(); location.reload()">ƒ∞lerlemeyi Sƒ±fƒ±rla</button>
        <button class="btn btn-secondary" style="margin-top:10px" onclick="document.getElementById('overlay-settings').classList.remove('active')">KAPAT</button>
    </div>
</div>

<script>
const CONSTANTS = { ROWS: 8, COLS: 8, COLORS: ['#ff758c', '#4facfe', '#a8e063', '#fff200', '#cd93ff'], TYPES: [0, 1, 2, 3, 4] };

const LEVELS = {
    1: { moves: 20, goals: [{ type: 'score', amount: 1000 }] },
    2: { moves: 25, goals: [{ type: 'collect', colorId: 0, amount: 15 }] },
    3: { moves: 30, goals: [{ type: 'cracks', amount: 8 }], layout: { cracks: [{r:3, c:3, lvl:2}, {r:3, c:4, lvl:2}, {r:4, c:3, lvl:2}, {r:4, c:4, lvl:2}, {r:2, c:2, lvl:1}, {r:2, c:5, lvl:1}, {r:5, c:2, lvl:1}, {r:5, c:5, lvl:1}] } },
    4: { moves: 35, goals: [{ type: 'score', amount: 3000 }, { type: 'collect', colorId: 1, amount: 20 }, { type: 'cracks', amount: 10 }], layout: { cracks: (() => { let arr = []; for(let c=0; c<8; c++) { arr.push({r:7, c:c, lvl:2}); arr.push({r:6, c:c, lvl:1}); } return arr; })() } }
};

// --- LEAGUE SYSTEM ---
class LeagueManager {
    constructor(data) {
        this.data = data;
        this.tiers = [
            { name: 'BRONZ', min: 0, class: 'badge-bronze' },
            { name: 'G√úM√ú≈û', min: 5000, class: 'badge-silver' },
            { name: 'ALTIN', min: 15000, class: 'badge-gold' },
            { name: 'KRƒ∞STAL', min: 30000, class: 'badge-crystal' }
        ];
        // Mock Names for Leaderboard
        this.bots = ["CandyKing", "PuzzlePro", "SweetTooth", "BuzKƒ±ran", "JellyBean", "StarPlayer", "≈ûanslƒ±Kedi", "NeonRider", "HexMaster"];
    }

    getCurrentTier() {
        // Find highest tier where score >= min
        let t = this.tiers[0];
        for(let i=0; i<this.tiers.length; i++) {
            if(this.data.weeklyScore >= this.tiers[i].min) t = this.tiers[i];
        }
        return t;
    }

    checkWeeklyReset() {
        const now = new Date();
        const weekId = `${now.getFullYear()}-W${this.getWeekNumber(now)}`;
        
        if (this.data.currentWeekId !== weekId) {
            console.log("Haftalƒ±k Reset!");
            this.data.weeklyScore = 0; // Reset score
            this.data.currentWeekId = weekId;
            this.data.save();
            alert("Yeni Hafta Ba≈üladƒ±! Lig skorlarƒ± sƒ±fƒ±rlandƒ±.");
        }
    }

    getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
    }

    addScore(points) {
        this.data.weeklyScore += points;
        this.data.save();
    }

    openLeague() {
        this.checkWeeklyReset();
        this.renderLeaderboard();
        document.getElementById('overlay-league').classList.add('active');
    }

    renderLeaderboard() {
        const currentTier = this.getCurrentTier();
        
        // Update UI Header
        document.getElementById('week-display').textContent = this.data.currentWeekId;
        const badgeEl = document.getElementById('league-tier-badge');
        badgeEl.className = `league-badge ${currentTier.class}`;
        badgeEl.textContent = `${currentTier.name} Lƒ∞Gƒ∞`;
        
        document.getElementById('my-weekly-score').textContent = this.data.weeklyScore + " Puan";

        // Generate Mock Data + User
        let leaderboard = [];
        
        // Add User
        leaderboard.push({ name: "SEN", score: this.data.weeklyScore, isMe: true });

        // Add Bots (with dynamic scores based on tier to make it competitive)
        this.bots.forEach((name, idx) => {
            // Random score around user score or tier baseline
            let base = currentTier.min;
            if(base === 0) base = 1000;
            
            // Random variance
            let score = Math.floor(base * (0.5 + Math.random() * 1.5));
            // Make top 3 very high
            if(idx < 3) score += Math.floor(Math.random() * 5000);
            
            leaderboard.push({ name: name, score: score, isMe: false });
        });

        // Sort descending
        leaderboard.sort((a, b) => b.score - a.score);

        // Render List
        const listEl = document.getElementById('lb-list');
        listEl.innerHTML = '';
        
        let myRank = "-";

        leaderboard.forEach((p, idx) => {
            const rank = idx + 1;
            if(p.isMe) myRank = rank;

            const div = document.createElement('div');
            div.className = 'leaderboard-item';
            if(p.isMe) div.style.background = "rgba(79, 172, 254, 0.1)";

            let rankClass = "lb-rank";
            if(rank === 1) rankClass += " lb-rank-1";
            else if(rank === 2) rankClass += " lb-rank-2";
            else if(rank === 3) rankClass += " lb-rank-3";

            div.innerHTML = `
                <div class="${rankClass}">#${rank}</div>
                <div class="lb-user">
                    <div class="lb-name">${p.name}</div>
                </div>
                <div class="lb-score">${p.score}</div>
            `;
            listEl.appendChild(div);
        });

        document.getElementById('my-rank').textContent = "#" + myRank;
    }
}

class GameData {
    constructor() {
        this.level = 1;
        this.tokens = 50;
        this.weeklyScore = 0;
        this.currentWeekId = "";
        this.load();
    }
    load() {
        const saved = localStorage.getItem('kirilma_league_save');
        if (saved) {
            const parsed = JSON.parse(saved);
            this.level = parsed.level || 1;
            this.tokens = parsed.tokens || 50;
            this.weeklyScore = parsed.weeklyScore || 0;
            this.currentWeekId = parsed.currentWeekId || "";
        }
    }
    save() {
        localStorage.setItem('kirilma_league_save', JSON.stringify({
            level: this.level, tokens: this.tokens,
            weeklyScore: this.weeklyScore, currentWeekId: this.currentWeekId
        }));
    }
    resetProgress() { localStorage.removeItem('kirilma_league_save'); }
}

class AudioController {
    constructor() { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); this.enabled = true; }
    toggle() { this.enabled = !this.enabled; document.getElementById('sound-toggle').textContent = this.enabled ? 'üîä' : 'üîá'; }
    playTone(f, t, d) { if (!this.enabled) return; try { const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); o.type = t; o.frequency.setValueAtTime(f, this.ctx.currentTime); g.gain.setValueAtTime(0.05, this.ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + d); o.connect(g); g.connect(this.ctx.destination); o.start(); o.stop(this.ctx.currentTime + d); } catch(e){} }
    playPop() { this.playTone(400, 'sine', 0.1); }
    playMatch() { this.playTone(600, 'sine', 0.15); setTimeout(() => this.playTone(800, 'sine', 0.1), 100); }
    playCrack() { this.playTone(200, 'sawtooth', 0.1); } 
    playWin() { [523,659,784,1046].forEach((f,i)=>setTimeout(()=>this.playTone(f,'sine',0.3),i*150)); }
    playError() { this.playTone(150, 'sawtooth', 0.2); }
}

class GameLogic {
    constructor() {
        this.grid = []; this.cellGrid = []; this.activeGoals = []; this.score = 0; this.moves = 0; this.input = new InputController(this);
    }

    initLevel(levelNum) {
        const config = LEVELS[levelNum] || this.generateRandomLevel(levelNum);
        this.score = 0; this.moves = config.moves;
        this.activeGoals = config.goals.map((g, idx) => ({ ...g, current: g.amount, id: idx }));
        
        this.cellGrid = [];
        for(let r=0; r<CONSTANTS.ROWS; r++) { this.cellGrid[r] = []; for(let c=0; c<CONSTANTS.COLS; c++) { this.cellGrid[r][c] = { crackLevel: 0, el: null }; } }
        if (config.layout && config.layout.cracks) { config.layout.cracks.forEach(c => { if(this.cellGrid[c.r] && this.cellGrid[c.r][c.c]) this.cellGrid[c.r][c.c].crackLevel = c.lvl; }); }

        Game.ui.updateLevelInfo(levelNum, this.moves, this.activeGoals);
        Game.ui.closeOverlays();
        this.createGrid(); this.resolveMatches(true);
    }

    generateRandomLevel(lvl) { return { moves: 20 + Math.floor(lvl/2), goals: [ { type: 'score', amount: lvl * 1500 }, { type: 'collect', colorId: Math.floor(Math.random()*5), amount: 15 + lvl } ] }; }

    createGrid() {
        const gridEl = document.getElementById('grid'); gridEl.innerHTML = ''; gridEl.style.gridTemplateColumns = `repeat(${CONSTANTS.COLS}, 1fr)`; this.grid = [];
        for (let r = 0; r < CONSTANTS.ROWS; r++) {
            this.grid[r] = [];
            for (let c = 0; c < CONSTANTS.COLS; c++) {
                const cellEl = document.createElement('div'); cellEl.className = 'cell';
                const crackEl = document.createElement('div'); crackEl.className = 'crack-layer';
                this.updateCrackVisualDOM(crackEl, this.cellGrid[r][c].crackLevel); this.cellGrid[r][c].el = crackEl; cellEl.appendChild(crackEl);
                let type = Math.floor(Math.random() * 5);
                this.grid[r][c] = { type: type, r: r, c: c, el: null };
                const tileEl = document.createElement('div'); tileEl.className = 'tile'; tileEl.dataset.type = type; tileEl.dataset.r = r; tileEl.dataset.c = c; this.grid[r][c].el = tileEl;
                cellEl.appendChild(tileEl); gridEl.appendChild(cellEl);
            }
        }
        this.input.attach(gridEl);
    }

    updateCrackVisualDOM(el, level) { el.className = 'crack-layer'; if (level > 0) el.classList.add('lvl-' + level); }

    attemptSwap(t1Coords, t2Coords) {
        const t1 = this.grid[t1Coords.r][t1Coords.c]; const t2 = this.grid[t2Coords.r][t2Coords.c];
        this.grid[t1.r][t1.c] = t2; this.grid[t2.r][t2.c] = t1; t1.r = t2Coords.r; t1.c = t2Coords.c; t2.r = t1Coords.r; t2.c = t1Coords.c;
        const cellNew1 = this.cellGrid[t1.r][t1.c].el.parentElement; const cellNew2 = this.cellGrid[t2.r][t2.c].el.parentElement;
        cellNew1.appendChild(t1.el); cellNew2.appendChild(t2.el); t1.el.dataset.r = t1.r; t1.el.dataset.c = t1.c; t2.el.dataset.r = t2.r; t2.el.dataset.c = t2.c;
        setTimeout(() => {
            const matches = this.findMatches();
            if(matches.length > 0) { this.moves--; Game.ui.updateHUD(); this.resolveMatches(false, matches); } 
            else { 
                Game.audio.playError();
                this.grid[t1.r][t1.c] = t2; this.grid[t2.r][t2.c] = t1;
                const tr = t1.r, tc = t1.c; t1.r = t2.r; t1.c = t2.c; t2.r = tr; t2.c = tc;
                const c1 = this.cellGrid[t1.r][t1.c].el.parentElement; const c2 = this.cellGrid[t2.r][t2.c].el.parentElement;
                c1.appendChild(t1.el); c2.appendChild(t2.el); t1.el.dataset.r = t1.r; t1.el.dataset.c = t1.c; t2.el.dataset.r = t2.r; t2.el.dataset.c = t2.c;
            }
        }, 200);
    }

    findMatches() {
        const matches = new Set();
        for (let r = 0; r < CONSTANTS.ROWS; r++) { for (let c = 0; c < CONSTANTS.COLS - 2; c++) { const type = this.grid[r][c].type; if (type === this.grid[r][c+1].type && type === this.grid[r][c+2].type) { matches.add(this.grid[r][c]); matches.add(this.grid[r][c+1]); matches.add(this.grid[r][c+2]); } } }
        for (let c = 0; c < CONSTANTS.COLS; c++) { for (let r = 0; r < CONSTANTS.ROWS - 2; r++) { const type = this.grid[r][c].type; if (type === this.grid[r+1][c].type && type === this.grid[r+2][c].type) { matches.add(this.grid[r][c]); matches.add(this.grid[r+1][c]); matches.add(this.grid[r+2][c]); } } }
        return Array.from(matches);
    }

    async resolveMatches(silent = false, initialMatches = null) {
        let matches = initialMatches || this.findMatches();
        let cascadeCount = 0;
        while (matches.length > 0) {
            cascadeCount++;
            if (!silent) { Game.audio.playMatch(); if(cascadeCount > 1) Game.ui.showFloatText("HARƒ∞KA!", matches[0].el); }
            for (let t of matches) {
                if (!silent) {
                    this.score += 10 * cascadeCount;
                    this.updateGoalProgress('collect', t.type);
                    const cell = this.cellGrid[t.r][t.c];
                    if (cell.crackLevel > 0) { cell.crackLevel--; this.updateCrackVisualDOM(cell.el, cell.crackLevel); Game.audio.playCrack(); if(cell.crackLevel === 0) this.updateGoalProgress('cracks', 1); }
                }
            }
            this.updateGoalProgress('score', this.score);
            if (!silent) { matches.forEach(t => t.el.classList.add('matched')); await new Promise(r => setTimeout(r, 250)); }
            matches.forEach(t => { if(t.el.parentElement) t.el.parentElement.removeChild(t.el); this.grid[t.r][t.c] = null; });
            await this.applyGravity();
            matches = this.findMatches();
            if (!silent) Game.ui.updateHUD();
        }
        if (!silent) this.checkGameState();
    }

    async applyGravity() {
        for (let c = 0; c < CONSTANTS.COLS; c++) {
            let emptySlots = 0;
            for (let r = CONSTANTS.ROWS - 1; r >= 0; r--) { if (this.grid[r][c] === null) { emptySlots++; } else if (emptySlots > 0) { const tile = this.grid[r][c]; this.grid[r + emptySlots][c] = tile; tile.r = r + emptySlots; this.grid[r][c] = null; } }
            for (let r = 0; r < emptySlots; r++) { const type = Math.floor(Math.random() * 5); this.grid[r][c] = { type: type, r: r, c: c, el: null }; }
        }
        for(let r=0; r<CONSTANTS.ROWS; r++) {
            for(let c=0; c<CONSTANTS.COLS; c++) {
                let t = this.grid[r][c]; const cell = this.cellGrid[r][c].el.parentElement;
                if (!t.el) { const tileEl = document.createElement('div'); tileEl.className = 'tile falling'; tileEl.dataset.type = t.type; tileEl.dataset.r = r; tileEl.dataset.c = c; t.el = tileEl; cell.appendChild(tileEl); } 
                else { if (t.el.parentElement !== cell) { cell.appendChild(t.el); t.el.dataset.r = r; t.el.dataset.c = c; } }
            }
        }
        await new Promise(r => setTimeout(r, 100));
    }

    updateGoalProgress(type, val) {
        this.activeGoals.forEach(g => {
            if (g.isMet) return;
            if (type === 'score' && g.type === 'score') g.current = Math.max(0, g.amount - val);
            else if (type === 'collect' && g.type === 'collect' && g.colorId === val) g.current = Math.max(0, g.current - 1);
            else if (type === 'cracks' && g.type === 'cracks') g.current = Math.max(0, g.current - val);
            if (g.current <= 0) g.isMet = true;
        });
    }

    checkGameState() {
        const allMet = this.activeGoals.every(g => g.isMet);
        if (allMet) { Game.audio.playWin(); Game.ui.showLevelComplete(); } 
        else if (this.moves <= 0) Game.ui.showGameOver();
    }

    useBooster(type) {
        if (Game.data.tokens < 10) return alert("Yetersiz Jeton");
        Game.data.tokens -= 10;
        if(type === 'move') this.moves += 5;
        Game.ui.updateHUD(); Game.ui.toggleBoostDrawer();
    }
    
    restartLevel() { this.initLevel(Game.data.level); }
}

class UIManager {
    constructor() { this.overlayMain = document.getElementById('overlay-main'); this.boostDrawer = document.getElementById('boost-drawer'); }
    updateLevelInfo(lvl, moves, goals) { document.getElementById('level-display').textContent = 'SEVƒ∞YE ' + lvl; document.getElementById('moves-display').textContent = moves; document.getElementById('score-display').textContent = '0'; document.getElementById('token-count').textContent = Game.data.tokens; this.renderGoals(goals); }
    renderGoals(goals) {
        const container = document.getElementById('goal-container'); container.innerHTML = '';
        goals.forEach(g => {
            const div = document.createElement('div'); div.className = 'goal-item'; div.id = `goal-${g.id}`;
            let iconHtml = '';
            if(g.type === 'score') iconHtml = 'üèÜ'; 
            else if(g.type === 'collect') iconHtml = `<div class="mini-tile" style="background:${CONSTANTS.COLORS[g.colorId]}"></div>`;
            else if(g.type === 'cracks') iconHtml = `<div class="crack-icon"></div>`;
            div.innerHTML = `<div style="display:flex; align-items:center; gap:5px">${iconHtml}</div> <span class="goal-val">${g.current}</span>`;
            container.appendChild(div);
        });
    }
    updateHUD() {
        document.getElementById('moves-display').textContent = Game.logic.moves; document.getElementById('score-display').textContent = Game.logic.score; document.getElementById('token-count').textContent = Game.data.tokens;
        Game.logic.activeGoals.forEach(g => { const el = document.querySelector(`#goal-${g.id}`); if(el) { el.querySelector('.goal-val').textContent = g.current; if(g.isMet) el.classList.add('done'); } });
    }
    showFloatText(text, el) { if(!el) return; const rect = el.getBoundingClientRect(); const float = document.createElement('div'); float.className = 'float-text'; float.textContent = text; float.style.left = rect.left + 'px'; float.style.top = rect.top + 'px'; document.body.appendChild(float); setTimeout(() => float.remove(), 800); }
    
    showLevelComplete() {
        // LEAGUE INTEGRATION: Add score to league on win
        Game.league.addScore(Game.logic.score);
        
        this.overlayMain.classList.add('active');
        document.getElementById('overlay-title').textContent = "BA≈ûARDIN!";
        document.getElementById('overlay-title').className = "win-title";
        document.getElementById('overlay-msg').textContent = `+10 Jeton & +${Game.logic.score} Lig Puanƒ±`;
        Game.data.tokens += 10; Game.data.level++; Game.data.save();
        document.getElementById('overlay-buttons').innerHTML = `<button class="btn" onclick="Game.logic.initLevel(${Game.data.level})">DEVAM ET</button>`;
    }

    showGameOver() {
        this.overlayMain.classList.add('active'); document.getElementById('overlay-title').textContent = "Bƒ∞TTƒ∞!"; document.getElementById('overlay-title').className = "lose-title"; document.getElementById('overlay-msg').textContent = "";
        document.getElementById('overlay-buttons').innerHTML = `<button class="btn btn-boost" onclick="Game.logic.moves+=5; Game.ui.closeOverlays();">+5 HAMLE (10 Jeton)</button><button class="btn btn-secondary" onclick="Game.logic.restartLevel()">TEKRAR DENE</button>`;
    }

    closeOverlays() { this.overlayMain.classList.remove('active'); }
    toggleBoostDrawer() { this.boostDrawer.classList.toggle('open'); }
    toggleSettings() { document.getElementById('overlay-settings').classList.add('active'); }
    showHelp() { alert("Hedefleri tamamla!\nBuz kƒ±rmak i√ßin √ºst√ºnde e≈üle≈ütirme yap."); }
}

class InputController {
    constructor(logic) { this.logic = logic; this.isDragging = false; }
    attach(el) {
        const start = (x, y, t) => { if(this.logic.isProcessing) return; const tile = t.closest('.tile'); if(!tile) return; this.startTile = { r: +tile.dataset.r, c: +tile.dataset.c }; this.startX = x; this.startY = y; this.isDragging = true; };
        const move = (e) => { if(this.isDragging) e.preventDefault(); };
        const end = (x, y) => {
            if(!this.isDragging) return; this.isDragging = false; const dx = x - this.startX, dy = y - this.startY; if(Math.abs(dx) < 30 && Math.abs(dy) < 30) return;
            let tr = this.startTile.r, tc = this.startTile.c; if(Math.abs(dx) > Math.abs(dy)) { dx > 0 ? tc++ : tc--; } else { dy > 0 ? tr++ : tr--; }
            if(tr >= 0 && tr < 8 && tc >= 0 && tc < 8) { this.logic.attemptSwap(this.startTile, {r:tr, c:tc}); }
        };
        el.addEventListener('mousedown', e => start(e.clientX, e.clientY, e.target)); window.addEventListener('mouseup', e => end(e.clientX, e.clientY));
        el.addEventListener('touchstart', e => start(e.touches[0].clientX, e.touches[0].clientY, e.target), {passive: false}); el.addEventListener('touchmove', e => move(e), {passive: false}); el.addEventListener('touchend', e => end(e.changedTouches[0].clientX, e.changedTouches[0].clientY));
    }
}

// Init
const data = new GameData();
const Game = { 
    data: data, 
    audio: new AudioController(), 
    logic: new GameLogic(), 
    ui: new UIManager(),
    league: new LeagueManager(data) // Pass data to league
};
window.onload = () => {
    Game.league.checkWeeklyReset(); // Check date on load
    Game.logic.initLevel(Game.data.level);
};

</script>
</body>
</html>
